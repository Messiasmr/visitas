<!DOCTYPE html>
<html lang="pt-BR" class="responsive DesktopUI">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Comunidade :: {{ user['name'] }}</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="https://community.fastly.steamstatic.com/public/shared/css/motiva_sans.css" rel="stylesheet">
    <link href="https://community.fastly.steamstatic.com/public/shared/css/buttons.css" rel="stylesheet">
    <link href="https://community.fastly.steamstatic.com/public/shared/css/shared_global.css" rel="stylesheet">
    <link href="https://community.fastly.steamstatic.com/public/css/globalv2.css" rel="stylesheet">
    <link href="https://community.fastly.steamstatic.com/public/css/skin_1/profilev2.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/perfil.css">

    {% if user['background_image'] %}
    <style>
        body {
            background-image: url("/{{ user['background_image'] }}");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
    </style>
    {% endif %}
</head>

<body class="flat_page profile_page has_profile_background MidnightTheme responsive_page">
    
    <!-- Bot√£o de volta para home -->
    <a href="/" class="home-btn" style="position:absolute;top:24px;left:32px;z-index:1000;display:flex;align-items:center;gap:8px;">
        <img src="/static/excitebike_logo.png" alt="Home" style="width:38px;height:38px;">
    </a>

    <!-- Cabe√ßalho do perfil -->
    <div class="profile_header_bg">
        <div class="profile_header_content">

            <!-- Avatar e nome -->
            <div style="display: flex; align-items: center; gap: 18px;">
                <div class="profile_avatar">
                    {% if user['profile_picture'] %}
                        <img src="/{{ user['profile_picture'] }}" alt="Foto de Perfil">
                    {% else %}
                        <img src="https://community.cloudflare.steamstatic.com/public/images/avatars/ee/ee516b7c3d43b948efa027dc9d1fbff24696cd1_full.jpg" alt="Sem foto">
                    {% endif %}
                </div>
                <div>
                    <div class="profile_persona">{{ user['name'] }}</div>
                    <div class="profile_level">
                        <div>{{ user['level'] or 1 }}</div>
                        <span>N√≠vel</span>
                    </div>
                    {% if logged_user and user['user_id'] == logged_user['user_id'] %}
                        <a href="/logout"><button>Sair</button></a>
                        <div style="display: flex; gap: 12px; align-items: center; margin-top: 18px;">
                            <button id="show-edit-profile" class="btn-roxo">Editar Perfil</button>
                            <div style="position: relative;">
                                <button id="toggle-add-friend-search" class="btn-roxo">Adicionar Amigos</button>
                                <div id="add-friend-search-box"
                                    style="display: none; position: absolute; top: 42px; left: 0; background: #1b2838; border-radius: 8px; box-shadow: 0 2px 12px rgba(44,44,84,0.13); width: 320px; max-width: 90vw; z-index: 100; padding: 18px;">
                                    <form id="user-search-form" style="margin-bottom: 10px;">
                                        <input type="text" id="user-search-input" placeholder="Buscar usu√°rio por nome ou ID"
                                            style="padding:6px 12px; border-radius:4px; border:1px solid #6c5ce7; width: 80%;">
                                        <button type="submit" class="btn-roxo">Buscar</button>
                                    </form>
                                    <div id="user-search-results" style="max-height: 200px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Edi√ß√£o de perfil -->
            {% if logged_user and user['user_id'] == logged_user['user_id'] %}
            <div id="edit-profile-box" style="display:none; margin-top:18px;">
                <form action="/update-profile" method="post" enctype="multipart/form-data" class="profile_edit_form">
                    <label>Mudar foto de perfil:</label>
                    <input type="file" name="profile_picture"><br><br>

                    <label>Adicionar arte √∫nica:</label>
                    <input type="file" name="unique_art"><br><br>

                    <label>Resumo/Bio:</label>
                    <input type="text" name="bio" value="{{ user['bio'] or '' }}" maxlength="120" style="width:90%;"><br><br>

                    <label for="bg_image">Imagem de fundo:</label>
                    <input type="file" name="bg_image" id="bg_image" accept="image/*"><br><br>

                    <button type="submit">Atualizar</button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Arte √∫nica -->
    {% if user['unique_art'] %}
    <div class="art_section">
        <h3>Arte √∫nica</h3>
        <img src="/{{ user['unique_art'] }}" alt="Arte √∫nica">
    </div>
    {% endif %}

    <!-- Links r√°pidos -->
    <div class="quick_links">
        <a href="#">Jogos</a>
        <a href="#">Amigos</a>
        <a href="#">Invent√°rio</a>
    </div>

    <!-- Bio -->
    <div class="profile_bio">{{ user['bio'] or 'Adicione um resumo ao seu perfil.' }}</div>

    <!-- Ins√≠gnias -->
    <div class="badges">
        <h4>Ins√≠gnias</h4>
        {% for badge in user['badges'] or ['badge1', 'badge2'] %}
        <img src="/static/{{ badge }}.png" alt="Ins√≠gnia">
        {% endfor %}
    </div>

    <!-- Jogos favoritos -->
    <div class="games_section">
        <h4>Jogos Favoritos</h4>
        <div class="favoritos-container">
            {% if favorite_games %}
                {% for game in favorite_games %}
                    <div class="favorito-card">
                        <img src="{{ game.image }}" alt="{{ game.title }}" class="favorito-img">
                        <div class="favorito-title">{{ game.title }}</div>
                    </div>
                {% endfor %}
            {% else %}
                <span>Nenhum jogo adicionado.</span>
            {% endif %}
        </div>
    </div>

    <!-- Amigos -->
    <div class="friends_section">
        <h4>Amigos</h4>
        {% if friends %}
            {% for friend in friends %}
            <div class="friend_card">
                <img src="/{{ friend['profile_picture'] or 'static/default_avatar.png' }}" alt="{{ friend['name'] }}">
                <span>{{ friend['name'] }}</span>
            </div>
            {% endfor %}
        {% else %}
            <span>Nenhum amigo adicionado.</span>
        {% endif %}
    </div>

    <!-- Coment√°rios -->
    <div class="comments_section">
        <h4>Coment√°rios</h4>
        <form action="/add-comment" method="post">
            <input type="hidden" name="profile_owner" value="{{ user['email'] }}">
            <input type="text" name="comment" placeholder="Deixe um coment√°rio..." style="width:70%;">
            <button type="submit">Comentar</button>
        </form>
        {% for comment in comments or [] %}
        <div class="comment">
            <span class="comment_author">{{ comment['author_name'] }}</span>: {{ comment['text'] }}
        </div>
        {% else %}
        <span>Nenhum coment√°rio ainda.</span>
        {% endfor %}
    </div>

    <!-- Adicionar amigo -->
    {% if logged_user and user['user_id'] != logged_user['user_id'] %}
        {% if logged_user['user_id'] in user.get('friend_requests', []) %}
            <button disabled>Solicita√ß√£o enviada</button>
        {% elif user['user_id'] in logged_user.get('friends', []) %}
            <button disabled>J√° s√£o amigos</button>
        {% else %}
        <form action="/send-friend-request" method="post">
            <input type="hidden" name="to_user_id" value="{{ user['user_id'] }}">
            <button type="submit">Adicionar Amigo</button>
        </form>
        {% endif %}
    {% endif %}

    <!-- Notifica√ß√µes -->
    {% if logged_user and user['user_id'] == logged_user['user_id'] %}
    <div id="notification-bell-container">
        <button id="notification-bell" style="position:relative;">
            <span style="font-size:2em;">üîî</span>
            {% if user.get('friend_requests') %}
            <span id="notif-count">{{ user.friend_requests|length }}</span>
            {% endif %}
        </button>
        <div id="notif-dropdown">
            <h4>Solicita√ß√µes de amizade</h4>
            {% for req_id in user.get('friend_requests', []) %}
                {% set req_user = usuarios.find_one({'user_id': req_id}) %}
                <div>
                    <img src="/{{ req_user['profile_picture'] or 'static/default_avatar.png' }}">
                    <span>{{ req_user['name'] if req_user else 'Usu√°rio desconhecido' }}</span>
                    <form action="/respond-friend-request" method="post">
                        <input type="hidden" name="from_user_id" value="{{ req_id }}">
                        <button name="action" value="accept">Aceitar</button>
                        <button name="action" value="reject">Recusar</button>
                    </form>
                </div>
            {% else %}
                <span>Nenhuma notifica√ß√£o.</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Pesquisa de usu√°rios -->
    {% if logged_user and user['user_id'] == logged_user['user_id'] %}
    <div style="text-align:center;margin-top:30px;">
        
    </div>
    {% endif %}

    <!-- Scripts -->
    <script>
        // Toggle edi√ß√£o de perfil
        document.addEventListener('DOMContentLoaded', function () {
            const btn = document.getElementById('show-edit-profile');
            const box = document.getElementById('edit-profile-box');
            if (btn && box) {
                btn.onclick = () => {
                    const isVisible = box.style.display === 'block';
                    box.style.display = isVisible ? 'none' : 'block';
                    btn.textContent = isVisible ? 'Editar Perfil' : 'Fechar edi√ß√£o';
                };
            }
        });

        // Toggle e funcionalidade da pesquisa de amigos
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggle-add-friend-search');
            const searchBox = document.getElementById('add-friend-search-box');
            if(toggleBtn && searchBox){
                toggleBtn.onclick = function(e) {
                    e.stopPropagation();
                    searchBox.style.display = searchBox.style.display === 'block' ? 'none' : 'block';
                };
                document.body.addEventListener('click', function() {
                    searchBox.style.display = 'none';
                });
                searchBox.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                document.getElementById('user-search-form').onsubmit = async function(e) {
                    e.preventDefault();
                    const q = document.getElementById('user-search-input').value;
                    const res = await fetch(`/search-users?q=${encodeURIComponent(q)}`);
                    const users = await res.json();
                    const results = document.getElementById('user-search-results');
                    results.innerHTML = '';
                    if (users.length === 0) {
                        results.innerHTML = '<span style="color:#c7d5e0;">Nenhum usu√°rio encontrado.</span>';
                        return;
                    }
                    users.forEach(u => {
                        results.innerHTML += `
                            <div style="margin:10px 0; display:flex; align-items:center;">
                                <img src="/${u.profile_picture || 'static/default_avatar.png'}" style="width:32px;height:32px;border-radius:50%;vertical-align:middle;margin-right:8px;">
                                <span style="color:#a29bfe;font-weight:bold;margin:0 8px;">${u.name}</span>
                                <span style="color:#b2bec3;font-size:0.95em;">ID: ${u.user_id}</span>
                                <a href="/profile?id=${u.user_id}" style="color:#6c5ce7;margin-left:auto;">Ver perfil</a>
                            </div>
                        `;
                    });
                };
            }
        });

        // Notifica√ß√µes
        document.addEventListener('DOMContentLoaded', function () {
            const bell = document.getElementById('notification-bell');
            const dropdown = document.getElementById('notif-dropdown');

            if (bell && dropdown) {
                bell.onclick = function (e) {
                    e.stopPropagation();
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                document.body.addEventListener('click', function () {
                    dropdown.style.display = 'none';
                });
                dropdown.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            }
        });
    </script>
</body>
</html>

